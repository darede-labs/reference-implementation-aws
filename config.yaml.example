### Config for CNOE AWS Reference Implementation ###
# Source: "https://github.com/cnoe/reference-implementation-aws"

# Details of your repository fork
repo:
  url: "https://github.com/darede-labs/reference-implementation-aws"
  revision: "main"
  basepath: "packages"

################################################################################
# EKS Cluster Configuration
################################################################################

# The name of the EKS cluster you are installing the reference implementation on.
cluster_name: "idp-poc-darede-cluster"

# AWS Region of the EKS cluster
region: "us-east-1"

# Set this to "false" for Standard Mode with managed node groups (more control)
# Set this to "true" for EKS Auto Mode (fully managed, less config)
auto_mode: "false"

# IAM authentication method for service accounts
# Options: "irsa" (IAM Roles for Service Accounts - recommended, more compatible)
#          "pod-identity" (EKS Pod Identity - newer, requires specific SCP permissions)
# Recommended: "irsa" for most use cases (avoids SCP issues)
iam_auth_method: "irsa"

################################################################################
# Network Configuration
################################################################################

# VPC Configuration
vpc:
  # Set to "create" to create a new VPC, or "existing" to use an existing VPC
  mode: "create"

  # Only required if mode is "create"
  cidr: "10.0.0.0/16"

  # Only required if mode is "existing"
  # vpc_id: "vpc-xxxxx"
  # private_subnet_ids: ["subnet-xxxxx", "subnet-yyyyy", "subnet-zzzzz"]
  # public_subnet_ids: ["subnet-aaaaa", "subnet-bbbbb", "subnet-ccccc"]

  # Number of Availability Zones (only for mode "create")
  # Recommended: 3 for production, 2 for dev/staging
  availability_zones: 3

  # NAT Gateway strategy (only for mode "create")
  # Options: "single" (cheaper, $32/month), "one_per_az" (HA, $96/month for 3 AZs)
  nat_gateway_mode: "single"

################################################################################
# Node Provisioning Configuration
################################################################################

# Use Karpenter for dynamic node provisioning (recommended for cost optimization)
# Set to "true" to enable Karpenter, "false" to use managed node groups
use_karpenter: "true"

# Karpenter Configuration (only when use_karpenter is "true")
# Latest versions: https://github.com/aws/karpenter-provider-aws/tags
karpenter:
  # Karpenter Helm chart version
  # v1.8.5 (Jan 15, 2026) - Latest stable
  # v1.8.4 (Jan 13, 2026)
  # v1.7.4 (Dec 12, 2025)
  # v1.1.1 (Legacy - your previous version)
  version: "1.8.5"

  # Default instance types (Karpenter will choose based on workload)
  # Recommended: Use instance families for flexibility
  instance_types:
    - "t3a.medium"    # Primary: Best cost-performance
    - "t3.medium"     # Fallback: Widely available
    - "t2.medium"     # Fallback: Additional availability

  # Capacity type: "spot" (70% cheaper) or "on-demand" (reliable)
  # Karpenter can mix both based on availability
  capacity_type: "spot"  # Options: "spot", "on-demand", "spot-preferred"

  # Resource limits (to prevent runaway costs)
  limits:
    cpu: 20        # Maximum vCPUs across all Karpenter nodes
    memory: 80Gi   # Maximum memory across all Karpenter nodes

  # Consolidation: Automatically remove underutilized nodes
  consolidation_enabled: true

  # TTL: Time nodes stay empty before termination (in seconds)
  ttl_seconds_after_empty: 30

  # Disruption budget: Limit node replacements
  disruption_budget: "10%"  # Max 10% of nodes can be disrupted at once

  # Disk size per node in GB
  disk_size: 50

################################################################################
# Legacy Node Group Configuration (only when use_karpenter is "false")
################################################################################

node_groups:
  # Capacity type: "SPOT" (70% cheaper) or "ON_DEMAND" (reliable)
  capacity_type: "SPOT"

  instance_types:
    - "t3.medium"
    - "t3a.medium"
    - "t2.medium"

  # Auto Scaling configuration
  scaling:
    min_size: 2      # Minimum nodes for POC
    max_size: 4      # Maximum nodes
    desired_size: 2  # Initial nodes (cost-optimized)

  # Disk size per node in GB
  disk_size: 50

  # Node labels (for pod scheduling)
  labels:
    pool: "spot"
    workload: "general"
    cost-optimization: "enabled"

################################################################################
# Backstage Integration Repositories
################################################################################

# GitHub organization/user where repositories will be created
github_org: "darede-labs"

# GitHub Personal Access Token for Backstage integration
# Required scopes: repo, workflow, read:org, read:user
# Generate at: https://github.com/settings/tokens
# IMPORTANT: Set via environment variable GITHUB_TOKEN (never commit secrets!)
# github_token: "yourGHTOKEN"  # Set via: export GITHUB_TOKEN="ghp_xxxxx"

# Repository for infrastructure resources (S3, RDS, EKS, etc.)
# Backstage will create Pull Requests here when provisioning resources
infrastructure_repo: "infrastructureidp"

# Repository for Backstage templates
# Contains Software Templates for creating applications and resources
templates_repo: "backstage-templates"

################################################################################
# GitOps Repository Configuration
################################################################################

# GitOps repository URL and revision for ArgoCD App-of-Apps
# This repository contains the platform applications (Keycloak, Backstage, etc.)
gitops:
  repo_url: "https://github.com/<org>/<repo>"
  revision: "main"

################################################################################
# Secrets Configuration
################################################################################
# IMPORTANT: All secrets must be set via environment variables!
# Never commit secrets to this file - config.yaml is gitignored.
#
# Required environment variables:
#   - GITHUB_TOKEN: GitHub Personal Access Token (for repo access and Backstage)
#   - KEYCLOAK_ADMIN_PASSWORD: Keycloak admin password
#   - ARGOCD_CLIENT_SECRET: OIDC client secret for ArgoCD
#   - BACKSTAGE_CLIENT_SECRET: OIDC client secret for Backstage
#
# Example:
#   export GITHUB_TOKEN="ghp_xxxxx"
#   export KEYCLOAK_ADMIN_PASSWORD="changeme"
#   export ARGOCD_CLIENT_SECRET="$(openssl rand -hex 32)"
#   export BACKSTAGE_CLIENT_SECRET="$(openssl rand -hex 32)"

################################################################################
# Terraform Backend Configuration
################################################################################

# S3 bucket for Terraform state
terraform_backend:
  bucket: "poc-idp-tfstate"
  region: "us-east-1"
  # Using S3 native locking (use_lockfile) instead of DynamoDB
  use_lockfile: true

################################################################################
# Domain and DNS Configuration
################################################################################

# Base Domain name used for exposing services
# Examples:
#   - argocd.timedevops.click (subdomain routing)
#   - timedevops.click/argocd (path routing)
domain: "timedevops.click"

# Subdomain configuration for each service
# Set to empty string "" to use root domain with path routing
subdomains:
  argocd: "argocd"        # argocd.timedevops.click
  backstage: "backstage"  # backstage.timedevops.click
  # To use path routing, set all to "" and enable path_routing below

# Route53 hosted zone ID for configuring external-dns
route53_hosted_zone_id: "Z09212782MXWNY5EYNICO"

# Set this to "true" for path-based routing (domain.com/argocd)
# Set this to "false" for subdomain-based routing (argocd.domain.com)
path_routing: "false"

################################################################################
# TLS/SSL Configuration
################################################################################

# ACM Certificate ARN for TLS termination at NLB
# This certificate must cover *.domain (wildcard) or all subdomains
# Example: arn:aws:acm:us-east-1:123456789:certificate/xxx-xxx-xxx
acm_certificate_arn: "arn:aws:acm:us-east-1:948881762705:certificate/051f6515-0d0b-459c-a056-0663f7c88f5e"

# TLS termination point: "nlb" (ACM at NLB) or "nginx" (cert-manager at nginx)
# Recommended: "nlb" for ACM-managed certificates
tls_termination: "nlb"

################################################################################
# Identity Provider Configuration
################################################################################

# Choose identity provider: "cognito" or "keycloak"
# - cognito: AWS managed, limited user management UI
# - keycloak: Self-hosted, full admin UI, better for team management
identity_provider: "keycloak"

################################################################################
# Keycloak Configuration (when identity_provider: "keycloak")
################################################################################

keycloak:
  # Enable Keycloak deployment and RDS database
  enabled: "true"

  # Keycloak deployment configuration
  replicas: 1  # Single replica for POC (use 2+ for production HA)

  # Admin credentials (set via environment variable)
  admin_user: "admin"
  # admin_password: Set via environment variable KEYCLOAK_ADMIN_PASSWORD

  # Subdomain for Keycloak UI
  subdomain: "keycloak"  # Will be: keycloak.timedevops.click

  # Keycloak image tag (pinned version for bitnamilegacy)
  image_tag: "24.0.5"  # Use same version in realm-import-job.yaml

  # Database configuration
  database:
    # Instance type - cost optimized options:
    # - db.t4g.micro: ~$12/month (ARM Graviton2, cheapest)
    # - db.t3.micro: ~$14/month (x86, wider region support)
    # - db.t4g.small: ~$24/month (more performance if needed)
    instance_class: "db.t4g.micro"

    # Storage configuration (minimum for cost savings)
    allocated_storage: 20  # GB - minimum recommended

    # PostgreSQL version (Keycloak supports 12+)
    postgres_version: "15.15"

    # Database name and username
    name: "keycloak"
    username: "keycloak"

    # High availability (disable for cost savings in dev/POC)
    multi_az: "false"  # Set to "true" for production

    # Backup retention (1 day minimum for cost savings)
    backup_retention_days: 1  # Increase to 7-30 for production

################################################################################
# AWS Cognito Configuration (DEPRECATED - use Keycloak instead)
################################################################################
# NOTE: Cognito resources only created if identity_provider: "cognito"
# Keycloak is recommended for better user management
################################################################################

################################################################################
# Tags for AWS Resources
################################################################################
# OBRIGATÓRIO: Cloud Economics Tag para rastreamento de custos
# Formato: "Darede-<CÓDIGO_JIRA>::<vertical>"
# Exemplo: "Darede-RPCNE::netfound", "Darede-RPCNE::devops"
################################################################################

tags:
  # OBRIGATÓRIO - Cloud Economics (vertical DevOps)
  cloud_economics: "Darede-IDP::devops"

  # Tags adicionais para organização
  githubRepo: "github.com/darede-labs/reference-implementation-aws"
  env: "poc"
  project: "idp"
  owner: "platform-team"
  cost-center: "engineering"
