################################################################################
# Keycloak Database Secret Retrieval Job
# Generated from template - DO NOT EDIT MANUALLY
# Fetches RDS credentials from AWS Secrets Manager and creates K8s Secret
################################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keycloak-db-secret-fetcher
  namespace: keycloak
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::948881762705:role/external-secrets-irsa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keycloak-db-secret-manager
  namespace: keycloak
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "update", "patch", "get"]
  resourceNames: ["keycloak-db-credentials"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keycloak-db-secret-manager
  namespace: keycloak
subjects:
- kind: ServiceAccount
  name: keycloak-db-secret-fetcher
  namespace: keycloak
roleRef:
  kind: Role
  name: keycloak-db-secret-manager
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-db-secret-fetcher
  namespace: keycloak
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: keycloak-db-secret-fetcher
    spec:
      serviceAccountName: keycloak-db-secret-fetcher
      restartPolicy: OnFailure
      containers:
      - name: secret-creator
        image: amazon/aws-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Fetching database credentials from Secrets Manager..."

          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id arn:aws:secretsmanager:us-east-1:948881762705:secret:idp-poc-darede-cluster-keycloak-db-20260121194803447300000001-i20X4m \
            --region us-east-1 \
            --query SecretString \
            --output text)

          DB_USERNAME=$(echo "$SECRET_JSON" | jq -r .username)
          DB_PASSWORD=$(echo "$SECRET_JSON" | jq -r .password)
          DB_HOST=$(echo "$SECRET_JSON" | jq -r .host)
          DB_PORT=$(echo "$SECRET_JSON" | jq -r .port)
          DB_NAME=$(echo "$SECRET_JSON" | jq -r .dbname)
          
          echo "Creating Kubernetes secret via API..."
          
          # Base64 encode values
          USERNAME_B64=$(echo -n "$DB_USERNAME" | base64 -w 0)
          PASSWORD_B64=$(echo -n "$DB_PASSWORD" | base64 -w 0)
          HOST_B64=$(echo -n "$DB_HOST" | base64 -w 0)
          PORT_B64=$(echo -n "$DB_PORT" | base64 -w 0)
          DATABASE_B64=$(echo -n "$DB_NAME" | base64 -w 0)
          JDBC_URL_B64=$(echo -n "jdbc:postgresql://$DB_HOST:$DB_PORT/$DB_NAME" | base64 -w 0)
          
          # Create secret JSON
          cat <<EOF > /tmp/secret.json
          {
            "apiVersion": "v1",
            "kind": "Secret",
            "metadata": {
              "name": "keycloak-db-credentials",
              "namespace": "keycloak"
            },
            "type": "Opaque",
            "data": {
              "username": "$USERNAME_B64",
              "password": "$PASSWORD_B64",
              "host": "$HOST_B64",
              "port": "$PORT_B64",
              "database": "$DATABASE_B64",
              "jdbc-url": "$JDBC_URL_B64"
            }
          }
          EOF
          
          # Apply via Kubernetes API
          curl -s -X POST \
            -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
            -H "Content-Type: application/json" \
            --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            https://kubernetes.default.svc/api/v1/namespaces/keycloak/secrets \
            -d @/tmp/secret.json || \
          curl -s -X PUT \
            -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
            -H "Content-Type: application/json" \
            --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            https://kubernetes.default.svc/api/v1/namespaces/keycloak/secrets/keycloak-db-credentials \
            -d @/tmp/secret.json

          echo "âœ“ Secret created successfully"
        env:
        - name: AWS_REGION
          value: us-east-1
