apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-observability-labels
  annotations:
    policies.kyverno.io/title: Require Observability Labels
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Deployment, StatefulSet
    policies.kyverno.io/description: >-
      This policy validates that Deployments and StatefulSets have the required
      labels for observability integration with Grafana, Loki, and Prometheus.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-app-name-label
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
      validate:
        message: "Label 'app.kubernetes.io/name' is required for observability"
        pattern:
          metadata:
            labels:
              app.kubernetes.io/name: "?*"
          spec:
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: "?*"

    - name: check-component-label
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
      validate:
        message: "Label 'app.kubernetes.io/component' is recommended for observability"
        pattern:
          metadata:
            labels:
              app.kubernetes.io/component: "?*"

    - name: check-part-of-label
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
      validate:
        message: "Label 'app.kubernetes.io/part-of' is recommended for observability"
        pattern:
          metadata:
            labels:
              app.kubernetes.io/part-of: "?*"

    - name: validate-healthcheck-endpoints
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
      validate:
        message: "Containers should have liveness and readiness probes for proper monitoring"
        pattern:
          spec:
            template:
              spec:
                containers:
                  - name: "*"
                    livenessProbe:
                      httpGet:
                        path: "?*"
                        port: "?*"
                    readinessProbe:
                      httpGet:
                        path: "?*"
                        port: "?*"
