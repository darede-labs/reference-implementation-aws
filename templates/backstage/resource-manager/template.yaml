apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: resource-manager
  title: "ğŸ—‘ï¸ Delete My Resources"
  description: |
    View and delete resources you have created via Backstage.
    Resources are automatically listed from your Terraform state.
  tags:
    - terraform
    - aws
    - delete
    - management
spec:
  owner: platform-team
  type: management

  parameters:
    - title: "ğŸ—‘ï¸ Delete Resource"
      description: |
        ## ğŸ” Step 1: View Your Resources

        **Open this link in a new tab (Ctrl+Click or Cmd+Click):**

        ğŸ‘‰ https://backstage.timedevops.click/api/resources/resources

        Then **manually add** `?owner=YOUR_USERNAME` to the URL
        (replace YOUR_USERNAME with your Backstage login username)

        **Example:** If your username is `matheus-andrade`:
        ```
        https://backstage.timedevops.click/api/resources/resources?owner=matheus-andrade
        ```

        ## ğŸ“ Step 2: Fill the form below

        Copy the `type` and `name` from the JSON response and enter here.

        ğŸ”’ **Security:** You can only delete resources that you own.
      required:
        - resourceType
        - resourceName
        - confirmDeletion
      properties:
        resourceType:
          title: " Resource Type"
          type: string
          enum:
            - s3
            - ec2
            - lambda
            - rds
          default: s3
          description: Type from API response (e.g., "s3", "ec2")
        resourceName:
          title: " Resource Name"
          type: string
          description: Name from API response (e.g., "my-bucket-name")
          ui:autofocus: true
          ui:placeholder: "my-bucket-name"
        confirmDeletion:
          title: " I CONFIRM I want to PERMANENTLY DELETE this resource"
          type: boolean
          default: false
          ui:widget: checkbox

  steps:
    - id: fetch-base
      name: Fetch Terraform Config
      if: ${{ parameters.confirmDeletion == true }}
      action: fetch:template
      input:
        url: ./skeleton
        targetPath: ./terraform

    - id: terraform-destroy
      name: Destroy Resource
      if: ${{ parameters.confirmDeletion == true }}
      action: terraform:destroy
      input:
        terraformDir: ./terraform
        backendConfig:
          bucket: ${{ env.TERRAFORM_BACKEND_BUCKET | default('poc-idp-tfstate') }}
          key: ${{ parameters.resourceType }}/${{ user.entity.metadata.name | default('admin') }}/${{ parameters.resourceName }}/terraform.tfstate
          region: ${{ env.TERRAFORM_BACKEND_REGION | default('us-east-1') }}
        ownerEmail: ${{ user.entity.spec.profile.email | default('admin@darede.com.br') }}
        resourceOwner: ${{ user.entity.spec.profile.email | default('admin@darede.com.br') }}
        autoApprove: true

  output:
    links:
      - title: "ï¿½ View YOUR Resources (filtered by your username)"
        url: "https://backstage.timedevops.click/api/resources/resources?owner=${{ user.entity.metadata.name | default('admin') }}"
      - title: "ï¿½ï¿½ Back to Templates"
        url: /create
      - title: "ğŸ“‚ S3 State Bucket"
        url: "https://console.aws.amazon.com/s3/buckets/poc-idp-tfstate"
    text:
      - title: Status
        content: |
          ${{ parameters.confirmDeletion == true ? 'âœ… Resource deleted successfully' : 'âŒ Deletion cancelled - confirmation required' }}
      - title: "ğŸ‘¤ Your Username"
        content: ${{ user.entity.metadata.name | default('admin') }}
