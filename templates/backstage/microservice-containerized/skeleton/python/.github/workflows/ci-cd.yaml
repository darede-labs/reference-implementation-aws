name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: ${{ values.awsRegion }}
  ECR_REPOSITORY: ${{ values.name }}
  GITOPS_REPO: ${{ values.gitopsRepo }}
  GITOPS_ORG: ${{ values.gitHubOrg }}
  APP_NAME: ${{ values.name }}
  APP_NAMESPACE: ${{ values.namespace }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install validation tools
        run: |
          # Install yamllint
          pip install yamllint

          # Install kubeconform
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Check if ECR repository exists
        id: check-ecr-repo
        run: |
          if aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create ECR repository if not exists
        if: steps.check-ecr-repo.outputs.exists == 'false'
        run: |
          aws ecr create-repository \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_ORG }}/${{ env.APP_NAME }}-gitops
          token: ${{ secrets.GITHUB_TOKEN }}
          path: gitops

      - name: Ensure deployment.yaml exists in GitOps repo
        run: |
          if [[ ! -f "gitops/manifests/deployment.yaml" ]]; then
            echo "Creating initial deployment.yaml..."
            mkdir -p gitops/manifests
            cat > gitops/manifests/deployment.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: ${{ env.APP_NAMESPACE }}
            labels:
              app.kubernetes.io/name: ${{ env.APP_NAME }}
              app.kubernetes.io/component: backend
              app.kubernetes.io/part-of: platform-services
              app.kubernetes.io/version: "1.0.0"
          spec:
            replicas: 2
            selector:
              matchLabels:
                app.kubernetes.io/name: ${{ env.APP_NAME }}
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: ${{ env.APP_NAME }}
                  app.kubernetes.io/component: backend
                  app.kubernetes.io/part-of: platform-services
                  app.kubernetes.io/version: "1.0.0"
              spec:
                containers:
                - name: ${{ env.APP_NAME }}
                  image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
                  ports:
                  - containerPort: 8000
                    name: http
                  env:
                  - name: APP_NAME
                    value: "${{ env.APP_NAME }}"
                  - name: APP_DESCRIPTION
                    value: "Python FastAPI microservice"
                  resources:
                    requests:
                      cpu: 100m
                      memory: 128Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: http
                    initialDelaySeconds: 15
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /ready
                      port: http
                    initialDelaySeconds: 5
                    periodSeconds: 5
                    timeoutSeconds: 3
                    failureThreshold: 3
          EOF

            cd gitops
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add manifests/deployment.yaml
            git commit -m "chore: initialize deployment manifest"
            git push
            cd ..
          fi

      - name: Update image tag in GitOps repository
        env:
          NEW_IMAGE: ${{ steps.build-image.outputs.image }}
        run: |
          cd gitops
          yq eval ".spec.template.spec.containers[0].image = \"${NEW_IMAGE}\"" -i manifests/deployment.yaml

      - name: Validate Kubernetes manifests
        working-directory: gitops
        run: |
          # Validate with yamllint
          yamllint manifests/ || echo "yamllint warnings (non-blocking)"

          # Validate with kubeconform
          kubeconform \
            -strict \
            -ignore-missing-schemas \
            -kubernetes-version 1.28.0 \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -summary \
            manifests/

      - name: Commit and push to GitOps repo
        working-directory: gitops
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifests/deployment.yaml
          git commit -m "chore: update image to ${{ steps.build-image.outputs.image }}"
          git push
