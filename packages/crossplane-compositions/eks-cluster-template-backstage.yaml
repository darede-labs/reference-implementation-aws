apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: aws-eks-cluster
  title: AWS EKS Cluster (Crossplane)
  description: Provisiona cluster EKS completo com VPC, subnets, IAM roles, e node groups
  tags:
    - aws
    - eks
    - kubernetes
    - infrastructure
    - recommended
spec:
  owner: team-platform
  type: resource

  parameters:
    - title: Configura√ß√£o do Cluster EKS
      required:
        - clusterName
        - region
        - owner
      properties:
        clusterName:
          title: Nome do Cluster
          type: string
          description: Nome √∫nico do cluster EKS (lowercase, h√≠fens)
          pattern: '^[a-z0-9-]+$'
          ui:autofocus: true
          maxLength: 40

        region:
          title: AWS Region
          type: string
          description: Regi√£o AWS onde o cluster ser√° criado
          enum:
            - us-east-1
            - us-west-2
            - sa-east-1
          default: us-east-1

        kubernetesVersion:
          title: Kubernetes Version
          type: string
          description: Vers√£o do Kubernetes
          enum:
            - "1.28"
            - "1.29"
            - "1.30"
            - "1.31"
            - "1.32"
            - "1.33"
          default: "1.33"

        owner:
          title: Owner Team
          type: string
          description: Time respons√°vel pelo cluster
          ui:field: OwnerPicker
          ui:options:
            catalogFilter:
              kind: Group

        costCenter:
          title: Cost Center
          type: string
          description: Centro de custo para billing

    - title: Configura√ß√£o dos Node Groups
      required:
        - nodeInstanceType
      properties:
        nodeInstanceType:
          title: Node Instance Type
          type: string
          description: Tipo de inst√¢ncia EC2 para os nodes
          enum:
            - t3.small    # 2 vCPU, 2 GB RAM
            - t3.medium   # 2 vCPU, 4 GB RAM
            - t3.large    # 2 vCPU, 8 GB RAM
            - t3.xlarge   # 4 vCPU, 16 GB RAM
            - m5.large    # 2 vCPU, 8 GB RAM
            - m5.xlarge   # 4 vCPU, 16 GB RAM
          default: t3.medium

        minNodes:
          title: Minimum Nodes
          type: integer
          description: N√∫mero m√≠nimo de nodes
          minimum: 1
          maximum: 50
          default: 2

        maxNodes:
          title: Maximum Nodes
          type: integer
          description: N√∫mero m√°ximo de nodes
          minimum: 1
          maximum: 50
          default: 10

        desiredNodes:
          title: Desired Nodes
          type: integer
          description: N√∫mero desejado de nodes
          minimum: 1
          maximum: 50
          default: 3

    - title: Reposit√≥rio de Infraestrutura
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Infrastructure Repository
          type: string
          description: Reposit√≥rio onde os manifestos Crossplane ser√£o commitados
          default: github.com?repo=infrastructure&owner=darede-labs

  steps:
    - id: fetch-template
      name: Fetch Crossplane Template
      action: fetch:template
      input:
        url: ./templates/eks-cluster
        values:
          clusterName: ${{ parameters.clusterName }}
          region: ${{ parameters.region }}
          kubernetesVersion: ${{ parameters.kubernetesVersion }}
          nodeInstanceType: ${{ parameters.nodeInstanceType }}
          minNodes: ${{ parameters.minNodes }}
          maxNodes: ${{ parameters.maxNodes }}
          desiredNodes: ${{ parameters.desiredNodes }}
          owner: ${{ parameters.owner }}
          costCenter: ${{ parameters.costCenter }}

    - id: create-pr
      name: Create Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repoUrl }}
        branchName: add-eks-cluster-${{ parameters.clusterName }}
        title: 'feat: Add EKS cluster ${{ parameters.clusterName }}'
        description: |
          ## EKS Cluster Configuration

          **Cluster Details:**
          - **Cluster Name:** ${{ parameters.clusterName }}
          - **Region:** ${{ parameters.region }}
          - **Kubernetes Version:** ${{ parameters.kubernetesVersion }}

          **Node Group:**
          - **Instance Type:** ${{ parameters.nodeInstanceType }}
          - **Min Nodes:** ${{ parameters.minNodes }}
          - **Max Nodes:** ${{ parameters.maxNodes }}
          - **Desired Nodes:** ${{ parameters.desiredNodes }}

          **Ownership:**
          - **Owner:** ${{ parameters.owner }}
          - **Cost Center:** ${{ parameters.costCenter }}

          ---

          **‚ö†Ô∏è IMPORTANTE:**
          - Este cluster ser√° provisionado via Crossplane
          - Tempo estimado de cria√ß√£o: ~15-20 minutos
          - VPC completa ser√° criada automaticamente
          - IAM roles ser√£o criados automaticamente

          **Recursos que ser√£o criados:**
          - ‚úÖ VPC (10.0.0.0/16)
          - ‚úÖ 2 Public Subnets (10.0.1.0/24, 10.0.2.0/24)
          - ‚úÖ 2 Private Subnets (10.0.10.0/24, 10.0.11.0/24)
          - ‚úÖ Internet Gateway
          - ‚úÖ Route Tables
          - ‚úÖ IAM Role for EKS Cluster
          - ‚úÖ IAM Role for Node Group
          - ‚úÖ EKS Cluster
          - ‚úÖ EKS Node Group

          Provisioned via Backstage Self-Service Platform üöÄ

    - id: register
      name: Register in Catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['create-pr'].output.repoContentsUrl }}
        catalogInfoPath: '/eks-clusters/${{ parameters.clusterName }}/catalog-info.yaml'

  output:
    links:
      - title: Pull Request
        url: ${{ steps['create-pr'].output.remoteUrl }}
        icon: github
      - title: View in Catalog
        icon: catalog
        entityRef: ${{ steps.register.output.entityRef }}
      - title: AWS Console - EKS
        url: https://console.aws.amazon.com/eks/home?region=${{ parameters.region }}#/clusters/${{ parameters.clusterName }}
