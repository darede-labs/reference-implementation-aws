apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-bootstrap
  namespace: keycloak
  annotations:
    argocd.argoproj.io/sync-wave: "30"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: configure
        image: curlimages/curl:latest
        envFrom:
        - configMapRef:
            name: domain-config
        env:
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak
              key: admin-password
        - name: BACKSTAGE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-clients
              key: BACKSTAGE_CLIENT_SECRET
        - name: ARGOCD_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-clients
              key: ARGOCD_CLIENT_SECRET
        - name: KEYCLOAK_REALM
          valueFrom:
            configMapKeyRef:
              name: domain-config
              key: KEYCLOAK_REALM
              optional: true
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "ðŸ” Aguardando Keycloak estar pronto..."
          until curl -sf http://keycloak.keycloak.svc.cluster.local:80/realms/master > /dev/null 2>&1; do
            echo "â³ Keycloak nÃ£o estÃ¡ pronto ainda..."
            sleep 5
          done
          echo "âœ… Keycloak estÃ¡ respondendo!"

          # Build dynamic URLs from ConfigMap env vars
          BACKSTAGE_URL="https://${BACKSTAGE_SUBDOMAIN}.${DOMAIN}"
          ARGOCD_URL="https://${ARGOCD_SUBDOMAIN}.${DOMAIN}"
          KEYCLOAK_URL="https://${KEYCLOAK_SUBDOMAIN}.${DOMAIN}"
          KC_URL="http://keycloak.keycloak.svc.cluster.local:80"

          echo "ðŸ“‹ ConfiguraÃ§Ã£o de domÃ­nios:"
          echo "   Backstage: $BACKSTAGE_URL"
          echo "   ArgoCD: $ARGOCD_URL"
          echo "   Keycloak: $KEYCLOAK_URL"

          # Client secrets from environment (populated from keycloak-clients secret)
          BACKSTAGE_SECRET="${BACKSTAGE_CLIENT_SECRET:-backstage-secret-2024}"
          ARGOCD_SECRET="${ARGOCD_CLIENT_SECRET:-argocd-secret-2024}"
          REALM="${KEYCLOAK_REALM:-cnoe}"

          # Function to get admin token
          get_token() {
            curl -s -X POST "${KC_URL}/realms/${REALM}/protocol/openid-connect/token" \
              -d "client_id=admin-cli" \
              -d "username=admin" \
              -d "password=${KEYCLOAK_ADMIN_PASSWORD}" \
              -d "grant_type=password" | sed 's/.*"access_token":"\([^"]*\)".*/\1/'
          }

          echo "ðŸ”‘ Obtendo token de admin..."
          TOKEN=$(get_token)

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ Falha ao obter token - pode ser que o realm cnoe nÃ£o existe ainda"
            echo "â„¹ï¸  Este job requer que o realm cnoe jÃ¡ exista (criado via user-sso-config-job)"
            exit 0
          fi
          echo "âœ… Token obtido"

          # ============================================
          # CREATE GROUPS SCOPE WITH MAPPER
          # ============================================
          echo "ðŸ“¦ Criando scope 'groups' com mapper..."

          # Check if groups scope exists
          GROUPS_SCOPE=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/client-scopes" | grep -o '"name":"groups"' || echo "")

          if [ -z "$GROUPS_SCOPE" ]; then
            echo "âž• Criando client scope groups..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "groups",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "true"
                }
              }' \
              "${KC_URL}/admin/realms/${REALM}/client-scopes"
            echo "âœ… Scope groups criado"
          else
            echo "âœ… Scope groups jÃ¡ existe"
          fi

          # Get groups scope ID
          GROUPS_SCOPE_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/client-scopes" | \
            sed 's/},{/}\n{/g' | grep '"name":"groups"' | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          echo "   Groups scope ID: $GROUPS_SCOPE_ID"

          # Add groups mapper to scope
          if [ -n "$GROUPS_SCOPE_ID" ]; then
            echo "ðŸ“ Adicionando mapper de grupos..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "groups",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-group-membership-mapper",
                "config": {
                  "full.path": "false",
                  "introspection.token.claim": "true",
                  "userinfo.token.claim": "true",
                  "id.token.claim": "true",
                  "access.token.claim": "true",
                  "claim.name": "groups"
                }
              }' \
              "${KC_URL}/admin/realms/${REALM}/client-scopes/${GROUPS_SCOPE_ID}/protocol-mappers/models" 2>/dev/null || echo "   Mapper pode jÃ¡ existir"
          fi

          # ============================================
          # CONFIGURE BACKSTAGE CLIENT
          # ============================================
          echo "ðŸ”§ Configurando client backstage..."

          # Get backstage client ID
          BACKSTAGE_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/clients?clientId=backstage" | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          if [ -z "$BACKSTAGE_ID" ] || [ "$BACKSTAGE_ID" = "[]" ]; then
            echo "âž• Criando client backstage..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"clientId\": \"backstage\",
                \"enabled\": true,
                \"protocol\": \"openid-connect\",
                \"publicClient\": false,
                \"standardFlowEnabled\": true,
                \"directAccessGrantsEnabled\": true,
                \"secret\": \"${BACKSTAGE_SECRET}\",
                \"redirectUris\": [\"${BACKSTAGE_URL}/*\", \"http://localhost:7007/*\"],
                \"webOrigins\": [\"${BACKSTAGE_URL}\", \"http://localhost:7007\"],
                \"rootUrl\": \"${BACKSTAGE_URL}\"
              }" \
              "${KC_URL}/admin/realms/${REALM}/clients"

            BACKSTAGE_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/clients?clientId=backstage" | \
              sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)
          fi
          echo "   Backstage client ID: $BACKSTAGE_ID"

          # Add groups as optional scope to backstage
          if [ -n "$BACKSTAGE_ID" ] && [ -n "$GROUPS_SCOPE_ID" ]; then
            echo "ðŸ”— Associando groups ao backstage..."
            curl -s -X PUT -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/clients/${BACKSTAGE_ID}/optional-client-scopes/${GROUPS_SCOPE_ID}" || true
          fi

          # ============================================
          # CONFIGURE ARGOCD CLIENT
          # ============================================
          echo "ðŸ”§ Configurando client argocd..."

          ARGOCD_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/clients?clientId=argocd" | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          if [ -z "$ARGOCD_ID" ] || [ "$ARGOCD_ID" = "[]" ]; then
            echo "âž• Criando client argocd..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"clientId\": \"argocd\",
                \"enabled\": true,
                \"protocol\": \"openid-connect\",
                \"publicClient\": true,
                \"standardFlowEnabled\": true,
                \"directAccessGrantsEnabled\": false,
                \"redirectUris\": [\"${ARGOCD_URL}/auth/callback\", \"${ARGOCD_URL}/*\"],
                \"webOrigins\": [\"${ARGOCD_URL}\"],
                \"rootUrl\": \"${ARGOCD_URL}\"
              }" \
              "${KC_URL}/admin/realms/${REALM}/clients"

            ARGOCD_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/clients?clientId=argocd" | \
              sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)
          fi
          echo "   ArgoCD client ID: $ARGOCD_ID"

          # Add groups as optional scope to argocd
          if [ -n "$ARGOCD_ID" ] && [ -n "$GROUPS_SCOPE_ID" ]; then
            echo "ðŸ”— Associando groups ao argocd..."
            curl -s -X PUT -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/clients/${ARGOCD_ID}/optional-client-scopes/${GROUPS_SCOPE_ID}" || true
          fi

          # ============================================
          # CREATE TEST USERS
          # ============================================
          echo "ðŸ‘¥ Criando usuÃ¡rios de teste..."

          # Create userA
          USERA_EXISTS=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/users?username=usera" | grep -o '"username":"usera"' || echo "")

          if [ -z "$USERA_EXISTS" ]; then
            echo "âž• Criando userA..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "usera",
                "enabled": true,
                "email": "usera@example.com",
                "firstName": "User",
                "lastName": "A",
                "emailVerified": true,
                "credentials": [{"type": "password", "value": "userA123", "temporary": false}]
              }' \
              "${KC_URL}/admin/realms/${REALM}/users"
            echo "âœ… userA criado (senha: userA123)"
          else
            echo "âœ… userA jÃ¡ existe"
          fi

          # Create userB
          USERB_EXISTS=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/users?username=userb" | grep -o '"username":"userb"' || echo "")

          if [ -z "$USERB_EXISTS" ]; then
            echo "âž• Criando userB..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "userb",
                "enabled": true,
                "email": "userb@example.com",
                "firstName": "User",
                "lastName": "B",
                "emailVerified": true,
                "credentials": [{"type": "password", "value": "userB123", "temporary": false}]
              }' \
              "${KC_URL}/admin/realms/${REALM}/users"
            echo "âœ… userB criado (senha: userB123)"
          else
            echo "âœ… userB jÃ¡ existe"
          fi

          # ============================================
          # CREATE GROUPS
          # ============================================
          echo "ðŸ‘¥ Criando grupos..."

          # Create developers group
          DEVS_GROUP=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/groups" | grep -o '"name":"developers"' || echo "")

          if [ -z "$DEVS_GROUP" ]; then
            echo "âž• Criando grupo developers..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"name": "developers"}' \
              "${KC_URL}/admin/realms/${REALM}/groups"
          fi

          # Create admins group
          ADMINS_GROUP=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/groups" | grep -o '"name":"admins"' || echo "")

          if [ -z "$ADMINS_GROUP" ]; then
            echo "âž• Criando grupo admins..."
            curl -s -X POST -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"name": "admins"}' \
              "${KC_URL}/admin/realms/${REALM}/groups"
          fi

          # Add users to groups
          echo "ðŸ”— Adicionando usuÃ¡rios aos grupos..."

          USERA_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/users?username=usera" | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          USERB_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/users?username=userb" | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          DEVS_GROUP_ID=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "${KC_URL}/admin/realms/${REALM}/groups" | \
            sed 's/},{/}\n{/g' | grep '"name":"developers"' | \
            sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)

          if [ -n "$USERA_ID" ] && [ -n "$DEVS_GROUP_ID" ]; then
            curl -s -X PUT -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/users/${USERA_ID}/groups/${DEVS_GROUP_ID}" || true
            echo "   userA -> developers"
          fi

          if [ -n "$USERB_ID" ] && [ -n "$DEVS_GROUP_ID" ]; then
            curl -s -X PUT -H "Authorization: Bearer $TOKEN" \
              "${KC_URL}/admin/realms/${REALM}/users/${USERB_ID}/groups/${DEVS_GROUP_ID}" || true
            echo "   userB -> developers"
          fi

          echo ""
          echo "âœ… Keycloak bootstrap completo!"
          echo "   - Scope groups criado com mapper"
          echo "   - Client backstage configurado"
          echo "   - Client argocd configurado"
          echo "   - UsuÃ¡rios: usera/userA123, userb/userB123"
          echo "   - Grupos: developers, admins"
          echo ""
          echo "Client Secret: $BACKSTAGE_SECRET"
