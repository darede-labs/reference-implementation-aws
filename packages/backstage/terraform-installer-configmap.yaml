apiVersion: v1
kind: ConfigMap
metadata:
  name: terraform-installer
  namespace: backstage
data:
  install.sh: |
    #!/bin/bash
    set -e
    TERRAFORM_VERSION="1.7.5"

    echo "Installing packages..."
    apt-get update -qq > /dev/null 2>&1
    apt-get install -y -qq ca-certificates git wget unzip > /dev/null 2>&1

    echo "Installing Terraform..."
    wget -q "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -O /tmp/terraform.zip
    unzip -q /tmp/terraform.zip -d /tools
    chmod +x /tools/terraform

    echo "Copying git and dependencies..."
    cp /usr/bin/git /tools/
    chmod +x /tools/git

    mkdir -p /tools/usr/lib /tools/lib/x86_64-linux-gnu
    cp -r /usr/lib/git-core /tools/usr/lib/

    echo "Copying shared libraries..."
    # Copy all libraries needed by git and git-remote-https
    for binary in /usr/bin/git /usr/lib/git-core/git-remote-https; do
      ldd "$binary" 2>/dev/null | grep '=>' | awk '{print $3}' | while read lib; do
        if [ -f "$lib" ] && [ ! -f "/tools/lib/x86_64-linux-gnu/$(basename $lib)" ]; then
          cp -L "$lib" /tools/lib/x86_64-linux-gnu/ 2>/dev/null || true
        fi
      done
    done

    # Copy base libraries
    cp /lib/x86_64-linux-gnu/libc.so.6 /tools/lib/x86_64-linux-gnu/ 2>/dev/null || true

    echo "Copying SSL certificates..."
    mkdir -p /tools/etc/ssl/certs
    cp -r /etc/ssl/certs/* /tools/etc/ssl/certs/

    echo "âœ… Installation complete"
    /tools/terraform version
    echo "Git libraries: $(ls /tools/lib/x86_64-linux-gnu/ | wc -l) files"
