# Ref: https://github.com/backstage/charts/tree/main/charts/backstage
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    external-dns.alpha.kubernetes.io/hostname: backstage.timedevops.click
    argocd.argoproj.io/sync-wave: "30"
  host: backstage.timedevops.click
  extraHosts: []
  path: "/"
  tls:
    enabled: true
    secretName: "backstage-server-tls"
backstage:
  replicas: 1
  image:
    registry: ghcr.io
    repository: cnoe-io/backstage-app
    tag: latest
    pullPolicy: IfNotPresent
  command: ["node", "packages/backend"]
  extraEnvVarsSecrets:
    - backstage-env-vars
  extraEnvVars:
    - name: BACKSTAGE_FRONTEND_URL
      value: https://backstage.timedevops.click
    - name: KEYCLOAK_NAME_METADATA
      value: https://keycloak.timedevops.click/auth/realms/cnoe/.well-known/openid-configuration
    - name: ARGO_CD_URL
      value: https://argocd.timedevops.click
    - name: ARGO_WORKFLOWS_URL
      value: https://argo-workflows.timedevops.click
  # extraVolumeMounts:
  #   - name: backstage-config
  #     mountPath: "/app/config"
  #     readOnly: true
  # extraVolumes:
  #   - name: backstage-config
  #     projected:
  #       sources:
  #         - secret:
  #             name: integrations
  #             items:
  #               - key: github-integration.yaml
  #                 path: github-integration.yaml
  #         - secret:
  #             name: k8s-config
  #             items:
  #               - key: k8s-config.yaml
  #                 path: k8s-config.yaml
  appConfig:
    app:
      title: Darede Backstage
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
    organization:
      name: darede
    backend:
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
      csp:
        connect-src: ['self', 'http:', 'https:']
      cors:
        origin: ${BACKSTAGE_FRONTEND_URL}
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
      cache:
        store: memory
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
    catalog:
      # Refresh automático dos templates e catalog entities
      refreshIntervalSeconds: 100
      locations:
        - type: url
          target: https://github.com/darede-labs/infrastructureidp/blob/main/catalog-info.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API]
      processors:
        githubOrg:
          providers:
            - target: https://github.com
              token: ${GITHUB_TOKEN}
    proxy:
      '/argo-workflows/api':
        target: ${ARGO_WORKFLOWS_URL}
        changeOrigin: true
        secure: true
        headers:
          Authorization:
            $env: ARGO_WORKFLOWS_AUTH_TOKEN
      '/argocd/api':
        target: ${ARGO_CD_URL}
        changeOrigin: true
        headers:
          Cookie:
            $env: ARGOCD_AUTH_TOKEN
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
    auth:
      environment: development
      session:
        secret: "MW2sV-sIPngEl26vAzatV-6VqfsgAx4bPIz7PuE_2Lk="
      providers:
        guest: {}
        keycloak-oidc:
          development:
            metadataUrl: ${KEYCLOAK_NAME_METADATA}
            clientId: backstage
            clientSecret: ${BACKSTAGE_CLIENT_SECRET}
            scope: 'openid profile email'
            prompt: auto
            # Desabilitar adição automática de scopes adicionais (como groups)
            # que causam erro no Keycloak 17
            dangerouslyAllowSignInWithoutUserInCatalog: true
            # Desabilitar resolução automática de groups
            resolver: {}
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail

    scaffolder:
    catalog:
      import:
        entityFilename: catalog-info.yaml
        pullRequestBranchName: backstage-integration
      rules:
        - allow: [Component, System, API, Resource, Location, Template]
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: 'config'
          clusters: []
    argocd:
      username: admin
      password: ${ARGOCD_ADMIN_PASSWORD}
      appLocatorMethods:
        - type: 'config'
          instances:
            - name: in-cluster
              url: ${ARGO_CD_URL}
              username: admin
              password: ${ARGOCD_ADMIN_PASSWORD}
    argoWorkflows:
      baseUrl: ${ARGO_WORKFLOWS_URL}
postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: 17.6.0-debian-12-r4
  auth:
    username: "backstage"
    existingSecret: "backstage-env-vars"
    secretKeys:
      adminPasswordKey: POSTGRES_PASSWORD
      userPasswordKey: POSTGRES_PASSWORD
  architecture: standalone
serviceAccount:
  create: true
