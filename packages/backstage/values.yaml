# Ref: https://github.com/backstage/charts/tree/main/charts/backstage
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    external-dns.alpha.kubernetes.io/hostname: backstage.timedevops.click
    argocd.argoproj.io/sync-wave: "30"
  host: backstage.timedevops.click
  extraHosts: []
  path: "/"
  tls:
    enabled: true
    secretName: "backstage-server-tls"
backstage:
  replicas: 1
  image:
    registry: ghcr.io
    repository: cnoe-io/backstage-app
    tag: latest
    pullPolicy: IfNotPresent
  command: ["node", "packages/backend"]
  extraEnvVarsSecrets:
    - backstage-env-vars
  extraEnvVars:
    - name: BACKSTAGE_FRONTEND_URL
      value: https://backstage.timedevops.click
    - name: KEYCLOAK_NAME_METADATA
      value: http://keycloak.keycloak.svc.cluster.local:80/realms/cnoe/.well-known/openid-configuration
    - name: ARGO_CD_URL
      value: https://argocd.timedevops.click
    - name: ARGO_WORKFLOWS_URL
      value: https://argo-workflows.timedevops.click
    # Platform Configuration - loaded from backstage-env-vars secret (populated by install.sh from config.yaml)
    - name: GITHUB_ORG
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: GITHUB_ORG
    - name: INFRA_REPO
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: INFRA_REPO
    - name: TERRAFORM_BACKEND_BUCKET
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: TERRAFORM_BACKEND_BUCKET
    - name: TERRAFORM_BACKEND_REGION
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: TERRAFORM_BACKEND_REGION
  # extraVolumeMounts:
  #   - name: backstage-config
  #     mountPath: "/app/config"
  #     readOnly: true
  # extraVolumes:
  #   - name: backstage-config
  #     projected:
  #       sources:
  #         - secret:
  #             name: integrations
  #             items:
  #               - key: github-integration.yaml
  #                 path: github-integration.yaml
  #         - secret:
  #             name: k8s-config
  #             items:
  #               - key: k8s-config.yaml
  #                 path: k8s-config.yaml
  appConfig:
    app:
      title: Darede Backstage
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
    organization:
      name: darede
    backend:
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
      csp:
        connect-src: ['self', 'http:', 'https:']
      cors:
        origin: ${BACKSTAGE_FRONTEND_URL}
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
      cache:
        store: memory
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
    catalog:
      # Refresh automático dos templates e catalog entities
      refreshIntervalSeconds: 100
      rules:
        - allow: [Template, Location, Component, Resource, API, System, Group, User]
      locations:
        # Terraform Templates (via Atlantis GitOps)
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-s3/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-ec2/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-security-group/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-vpc/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-eks/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-secrets/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/terraform-destroy/template.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        # Auto-discover infrastructure resources created via Backstage templates
        - type: url
          target: https://github.com/darede-labs/infrastructureidp/blob/main/catalog-info.yaml
          rules:
            - allow: [Location, Component, Resource, API, System]
      providers:
        github:
          infrastructureResources:
            organization: 'darede-labs'
            catalogPath: '/platform/terraform/stacks/**/catalog-info.yaml'
            filters:
              repository: 'infrastructureidp'
            schedule:
              frequency: { minutes: 5 }
              timeout: { minutes: 3 }
      processors:
        githubOrg:
          providers:
            - target: https://github.com
              token: ${GITHUB_TOKEN}
    proxy:
      '/argo-workflows/api':
        target: ${ARGO_WORKFLOWS_URL}
        changeOrigin: true
        secure: true
        headers:
          Authorization:
            $env: ARGO_WORKFLOWS_AUTH_TOKEN
      '/argocd/api':
        target: ${ARGO_CD_URL}
        changeOrigin: true
        headers:
          Cookie:
            $env: ARGOCD_AUTH_TOKEN
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
    auth:
      environment: development
      session:
        secret: "MW2sV-sIPngEl26vAzatV-6VqfsgAx4bPIz7PuE_2Lk="
      providers:
        guest: {}
        keycloak-oidc:
          development:
            metadataUrl: ${KEYCLOAK_NAME_METADATA}
            clientId: backstage
            clientSecret: ${BACKSTAGE_CLIENT_SECRET}
            scope: 'openid profile email'
            prompt: auto
            # Desabilitar adição automática de scopes adicionais (como groups)
            # que causam erro no Keycloak 17
            dangerouslyAllowSignInWithoutUserInCatalog: true
            # Desabilitar resolução automática de groups
            resolver: {}
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail

    scaffolder:
      # Default values for scaffolder - accessible via ${GITHUB_ORG} etc in templates
      defaultAuthor:
        name: Backstage Scaffolder
        email: scaffolder@backstage.io
      defaultCommitMessage: "feat: created via Backstage scaffolder"
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: local
              authProvider: serviceAccount
              serviceAccountToken: ${K8S_SA_TOKEN}
              skipTLSVerify: true
    argocd:
      username: admin
      password: ${ARGOCD_ADMIN_PASSWORD}
      appLocatorMethods:
        - type: 'config'
          instances:
            - name: in-cluster
              url: ${ARGO_CD_URL}
              username: admin
              password: ${ARGOCD_ADMIN_PASSWORD}
    argoWorkflows:
      baseUrl: ${ARGO_WORKFLOWS_URL}
postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: 17.6.0-debian-12-r4
  auth:
    username: "backstage"
    existingSecret: "backstage-env-vars"
    secretKeys:
      adminPasswordKey: POSTGRES_PASSWORD
      userPasswordKey: POSTGRES_PASSWORD
  architecture: standalone
serviceAccount:
  create: true
