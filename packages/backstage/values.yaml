# Ref: https://github.com/backstage/charts/tree/main/charts/backstage
# NOTE: This file is a TEMPLATE. Domain-specific values are injected by install.sh
# from config.yaml at install time. Do NOT hardcode domain values here.
ingress:
  enabled: true
  className: "nginx"
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  # host: set by install.sh from config.yaml
  extraHosts: []
  path: "/"
  tls:
    enabled: false
backstage:
  replicas: 2
  image:
    registry: public.ecr.aws
    repository: a7h4f2f7/backstage-idp
    tag: v1.1.6
    pullPolicy: IfNotPresent
  command: ["node", "packages/backend"]
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  extraEnvVarsSecrets:
    - backstage-env-vars
  extraEnvVars:
    # All env vars are loaded from backstage-env-vars secret (populated by install.sh from config.yaml)
    - name: GITHUB_ORG
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: GITHUB_ORG
    - name: INFRA_REPO
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: INFRA_REPO
    - name: TERRAFORM_BACKEND_BUCKET
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: TERRAFORM_BACKEND_BUCKET
    - name: TERRAFORM_BACKEND_REGION
      valueFrom:
        secretKeyRef:
          name: backstage-env-vars
          key: TERRAFORM_BACKEND_REGION
    - name: PATH
      value: "/tools:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    - name: GIT_EXEC_PATH
      value: "/tools/usr/lib/git-core"
    # LD_LIBRARY_PATH will be set by initContainer based on detected architecture
    # Default to x86_64 for backward compatibility, initContainer will update if needed
    # LD_LIBRARY_PATH: Set to include both paths, initContainer will create correct structure
    # The initContainer install script detects architecture and creates /tools/lib/{arch}-linux-gnu
    # Using both paths ensures compatibility regardless of architecture
    - name: LD_LIBRARY_PATH
      value: "/tools/lib/aarch64-linux-gnu:/tools/lib/x86_64-linux-gnu"
    - name: SSL_CERT_DIR
      value: "/tools/etc/ssl/certs"
    - name: SSL_CERT_FILE
      value: "/tools/etc/ssl/certs/ca-certificates.crt"
    - name: GIT_SSL_CAINFO
      value: "/tools/etc/ssl/certs/ca-certificates.crt"
  extraVolumeMounts:
    - name: catalog-users
      mountPath: "/catalog"
      readOnly: true
    - name: terraform-tools
      mountPath: "/tools"
  extraVolumes:
    - name: catalog-users
      configMap:
        name: backstage-users
    - name: terraform-tools
      emptyDir: {}
    - name: terraform-installer
      configMap:
        name: terraform-installer
        defaultMode: 493
  initContainers:
    - name: install-terraform
      image: debian:12-slim
      command: ["/bin/bash", "/scripts/install.sh"]
      volumeMounts:
        - name: terraform-tools
          mountPath: /tools
        - name: terraform-installer
          mountPath: /scripts
  appConfig:
    app:
      title: Darede Backstage
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
    organization:
      name: darede
    backend:
      baseUrl: ${BACKSTAGE_FRONTEND_URL}
      auth:
        externalAccess:
          - type: legacy
            options:
              secret: ${BACKEND_SECRET}
              subject: e2e-api
            accessRestrictions:
              - plugin: scaffolder
              - plugin: catalog
      csp:
        connect-src: ['self', 'http:', 'https:']
      cors:
        origin: ${BACKSTAGE_FRONTEND_URL}
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
      cache:
        store: memory
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
    catalog:
      # Refresh autom√°tico dos templates e catalog entities
      refreshIntervalSeconds: 100
      rules:
        - allow: [Template, Location, Component, Resource, API, System, Group, User]
      locations:
        # All Templates via catalog-info.yaml
        - type: url
          target: https://github.com/darede-labs/reference-implementation-aws/blob/main/templates/backstage/catalog-info.yaml
          rules:
            - allow: [Template, Location, Component, Resource, API, System]
        # Users and Groups (local file from ConfigMap)
        - type: file
          target: /catalog/users-catalog.yaml
          rules:
            - allow: [User, Group]
      providers:
        github:
          infrastructureResources:
            organization: 'darede-labs'
            catalogPath: '/platform/terraform/stacks/**/catalog-info.yaml'
            filters:
              repository: 'infrastructureidp'
            schedule:
              frequency: { minutes: 5 }
              timeout: { minutes: 3 }
      processors:
        githubOrg:
          providers:
            - target: https://github.com
              token: ${GITHUB_TOKEN}
    proxy:
      '/argo-workflows/api':
        target: ${ARGO_WORKFLOWS_URL}
        changeOrigin: true
        secure: true
        headers:
          Authorization:
            $env: ARGO_WORKFLOWS_AUTH_TOKEN
      # ArgoCD proxy removed - only needed when ArgoCD is installed
      # '/argocd/api':
      #   target: ${ARGO_CD_URL}
      #   changeOrigin: true
      #   headers:
      #     Cookie:
      #       $env: ARGOCD_AUTH_TOKEN
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
    auth:
      environment: production
      session:
        secret: ${AUTH_SESSION_SECRET}
      providers:
        oidc:
          production:
            metadataUrl: ${OIDC_ISSUER_URL}/.well-known/openid-configuration
            clientId: ${OIDC_CLIENT_ID}
            clientSecret: ${OIDC_CLIENT_SECRET}
            additionalScopes: ['profile', 'email']
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailLocalPartMatchingUserEntityName
                - resolver: emailMatchingUserEntityProfileEmail
          development:
            metadataUrl: ${OIDC_ISSUER_URL}/.well-known/openid-configuration
            clientId: ${OIDC_CLIENT_ID}
            clientSecret: ${OIDC_CLIENT_SECRET}
            additionalScopes: ['profile', 'email']
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailLocalPartMatchingUserEntityName
                - resolver: emailMatchingUserEntityProfileEmail
    signInPage: oidc

    scaffolder:
      # Default values for scaffolder - accessible via ${GITHUB_ORG} etc in templates
      defaultAuthor:
        name: Backstage Scaffolder
        email: scaffolder@backstage.io
      defaultCommitMessage: "feat: created via Backstage scaffolder"
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: local
              authProvider: serviceAccount
              serviceAccountToken: ${K8S_SA_TOKEN}
              skipTLSVerify: true
    argocd:
      username: admin
      password: ${ARGOCD_ADMIN_PASSWORD}
      appLocatorMethods:
        # ArgoCD integration removed - only needed when ArgoCD is installed
        # - type: 'config'
        #   instances:
        #     - name: in-cluster
        #       url: ${ARGO_CD_URL}
        #       username: admin
        #       password: ${ARGOCD_ADMIN_PASSWORD}
    argoWorkflows:
      baseUrl: ${ARGO_WORKFLOWS_URL}
postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: 17.6.0-debian-12-r4
  auth:
    username: "backstage"
    existingSecret: "backstage-env-vars"
    secretKeys:
      adminPasswordKey: POSTGRES_PASSWORD
      userPasswordKey: POSTGRES_PASSWORD
  architecture: standalone
  primary:
    persistence:
      enabled: true
      size: 20Gi
      storageClass: "gp3"  # AWS EBS gp3 for better performance
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"
serviceAccount:
  create: true
